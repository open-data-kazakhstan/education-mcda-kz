import os
import json
import pandas as pd

# Путь к данным
data_file_path = "data/data_norm.csv"
datapackage_path = "datapackage.json"

# Настройка базового datapackage.json
datapackage = {
    "name": "education-kz",
    "title": "Education in Kazakhstan",
    "description": "Dataset with educational and socio-economic indicators across Kazakhstan regions.",
    "resources": []
}

# Проверка, существует ли файл с данными
if not os.path.exists(data_file_path):
    raise FileNotFoundError(f"Файл {data_file_path} не найден. Проверьте путь к данным.")

# Считывание данных для получения структуры
try:
    df = pd.read_csv(data_file_path, sep=';', encoding='utf-8')
except Exception as e:
    raise ValueError(f"Ошибка при чтении файла: {e}")

# Генерация схемы данных
schema = {
    "fields": []
}

for column in df.columns:
    # Определение типа данных
    dtype = str(df[column].dtype)
    if dtype.startswith('int') or dtype.startswith('float'):
        field_type = "number"
    elif dtype == "object":
        field_type = "string"
    else:
        field_type = "string"  # По умолчанию

    # Добавление поля в схему
    schema["fields"].append({
        "name": column,
        "type": field_type
    })

# Добавление описания ресурса
resource = {
    "name": "data_norm",
    "path": data_file_path,
    "format": "csv",
    "encoding": "utf-8",
    "schema": schema
}

datapackage["resources"].append(resource)

# Сохранение datapackage.json
with open(datapackage_path, "w", encoding="utf-8") as f:
    json.dump(datapackage, f, ensure_ascii=False, indent=4)

print(f"Файл {datapackage_path} успешно создан.")
